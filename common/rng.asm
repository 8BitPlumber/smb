

;
; Practice stuff
;
quick_resume_0:
	.byte $A5, $00, $00, $00, $00, $00, $00, $00 ; Base for 0
	.byte $26, $90, $DD, $FC, $47, $BF, $30, $00 ; Base for 100
	.byte $81, $98, $9B, $AA, $9D, $C8, $F3, $00 ; Base for 200
	.byte $2A, $A2, $F7, $B2, $5D, $39, $83, $00 ; Base for 300
	.byte $9F, $14, $2A, $02, $56, $52, $FE, $00 ; Base for 400
	.byte $9F, $4A, $74, $E0, $09, $C9, $DA, $00 ; Base for 500
	.byte $F2, $E9, $0C, $DE, $C7, $7A, $F4, $00 ; Base for 600
	.byte $18, $00, $30, $30, $50, $30, $90, $00 ; Base for 700
	.byte $02, $AC, $A9, $F0, $A3, $42, $04, $00 ; Base for 800
	.byte $00, $B8, $B9, $C8, $BB, $2A, $5C, $00 ; Base for 900
	.byte $BD, $A0, $DB, $9A, $2D, $19, $43, $00 ; Base for 1000
	.byte $CF, $C8, $57, $C7, $68, $E6, $37, $00 ; Base for 1100
	.byte $12, $B4, $91, $F8, $DB, $2A, $9C, $00 ; Base for 1200
	.byte $55, $DB, $70, $C6, $27, $AB, $E4, $00 ; Base for 1300
	.byte $E1, $2C, $EE, $B7, $6A, $04, $D0, $00 ; Base for 1400
	.byte $36, $9A, $F7, $C2, $2D, $A9, $F2, $00 ; Base for 1500
	.byte $7C, $10, $E8, $C9, $18, $8A, $BB, $00 ; Base for 1600
	.byte $13, $4B, $6D, $FB, $20, $D6, $97, $00 ; Base for 1700
	.byte $6A, $06, $D2, $DF, $7A, $C4, $31, $00 ; Base for 1800
	.byte $1E, $DA, $E7, $52, $9C, $39, $01, $00 ; Base for 1900
	.byte $15, $87, $AC, $A3, $FA, $BD, $48, $00 ; Base for 2000
	.byte $B3, $20, $46, $06, $8A, $87, $92, $00 ; Base for 2100
	.byte $D2, $3D, $99, $E2, $D1, $14, $B6, $00 ; Base for 2200
	.byte $51, $B7, $14, $7A, $52, $A6, $03, $00 ; Base for 2300
	.byte $93, $98, $BF, $8E, $F1, $EC, $0F, $00 ; Base for 2400
	.byte $69, $F3, $20, $C6, $87, $0A, $04, $00 ; Base for 2500
	.byte $9F, $DE, $E1, $5C, $9E, $27, $1B, $00 ; Base for 2600
	.byte $D3, $52, $F4, $51, $B9, $1A, $68, $00 ; Base for 2700
	.byte $29, $37, $65, $0B, $C1, $D6, $55, $00 ; Base for 2800
	.byte $47, $43, $CD, $4A, $D0, $45, $E5, $00 ; Base for 2900
	.byte $28, $EC, $BD, $64, $1E, $D6, $EB, $00 ; Base for 3000
	.byte $29, $49, $1B, $89, $BE, $AD, $D0, $00 ; Base for 3100
quick_resume_32:
	.byte $1D, $D1, $EA, $49, $9D, $0E, $34, $00 ; Base for 3200
	.byte $12, $D4, $F1, $58, $BA, $0B, $7F, $00 ; Base for 3300
	.byte $0C, $88, $91, $80, $A3, $A2, $E5, $00 ; Base for 3400
	.byte $90, $5F, $7F, $C1, $3E, $BC, $C1, $00 ; Base for 3500
	.byte $77, $2D, $C3, $98, $1F, $2F, $11, $00 ; Base for 3600
	.byte $EC, $BF, $66, $18, $D4, $E5, $4C, $00 ; Base for 3700
	.byte $7A, $68, $9C, $4D, $75, $EF, $04, $00 ; Base for 3800
	.byte $DC, $E7, $5E, $90, $2D, $0D, $57, $00 ; Base for 3900
	.byte $47, $07, $89, $86, $95, $98, $B3, $00 ; Base for 4000
	.byte $20, $68, $28, $F8, $A9, $58, $0A, $00 ; Base for 4100
	.byte $92, $F1, $D4, $37, $9F, $F0, $CF, $00 ; Base for 4200
	.byte $44, $E6, $6F, $A3, $7C, $3A, $C2, $00 ; Base for 4300
	.byte $5C, $12, $AA, $8F, $DA, $C5, $70, $00 ; Base for 4400
	.byte $26, $56, $1A, $B6, $83, $EE, $E9, $00 ; Base for 4500
	.byte $66, $AA, $67, $33, $FD, $9A, $61, $00 ; Base for 4600
	.byte $DF, $52, $EC, $49, $91, $02, $20, $00 ; Base for 4700
	.byte $A8, $61, $31, $F3, $90, $77, $57, $00 ; Base for 4800
	.byte $47, $1F, $91, $AE, $8D, $D0, $CB, $00 ; Base for 4900
	.byte $76, $3C, $D0, $A9, $08, $5A, $4A, $00 ; Base for 5000
	.byte $CE, $AD, $30, $6A, $0A, $DE, $CB, $00 ; Base for 5100
	.byte $94, $8B, $A2, $B5, $F0, $9B, $7A, $00 ; Base for 5200
	.byte $B8, $39, $49, $3B, $A9, $DE, $8D, $00 ; Base for 5300
	.byte $7C, $1E, $E6, $DB, $16, $A0, $8D, $00 ; Base for 5400
	.byte $8B, $12, $04, $20, $28, $68, $38, $00 ; Base for 5500
	.byte $49, $25, $B7, $FC, $93, $6A, $4C, $00 ; Base for 5600
	.byte $E5, $1A, $D0, $E5, $44, $8E, $07, $00 ; Base for 5700
	.byte $4F, $6B, $F5, $22, $C8, $8D, $1C, $00 ; Base for 5800
	.byte $D3, $8A, $2D, $39, $63, $11, $D7, $00 ; Base for 5900
	.byte $CD, $C4, $5F, $D7, $68, $C6, $17, $00 ; Base for 6000
	.byte $F9, $F8, $0B, $FB, $EC, $1B, $C3, $00 ; Base for 6100
	.byte $7B, $EF, $18, $C6, $F7, $7A, $94, $00 ; Base for 6200
	.byte $EC, $3D, $E5, $9E, $55, $69, $C3, $00 ; Base for 6300
quick_resume_64:
	.byte $95, $DE, $F5, $48, $A2, $33, $77, $00 ; Base for 6400
	.byte $92, $AF, $8A, $D5, $C0, $6B, $EB, $00 ; Base for 6500
	.byte $29, $45, $17, $9D, $B2, $89, $EC, $00 ; Base for 6600
	.byte $B6, $FB, $96, $61, $4D, $8F, $14, $00 ; Base for 6700
	.byte $3C, $FA, $83, $76, $70, $9C, $7D, $00 ; Base for 6800
	.byte $64, $BE, $77, $0B, $E5, $F2, $39, $00 ; Base for 6900
	.byte $62, $4A, $8E, $1B, $07, $31, $3F, $00 ; Base for 7000
	.byte $DA, $09, $BD, $AE, $D5, $88, $23, $00 ; Base for 7100
	.byte $9A, $63, $57, $91, $3E, $1C, $60, $00 ; Base for 7200
	.byte $31, $53, $31, $97, $F4, $DB, $32, $00 ; Base for 7300
	.byte $7A, $5A, $AE, $1B, $47, $71, $FF, $00 ; Base for 7400
	.byte $43, $3D, $BB, $C0, $B7, $36, $58, $00 ; Base for 7500
	.byte $F2, $B3, $56, $30, $9C, $FD, $C4, $00 ; Base for 7600
	.byte $13, $45, $63, $E9, $2E, $FC, $A1, $00 ; Base for 7700
	.byte $F2, $5F, $BB, $04, $72, $7A, $9E, $00 ; Base for 7800
	.byte $3D, $F9, $82, $71, $75, $97, $7C, $00 ; Base for 7900
	.byte $EE, $47, $9B, $14, $22, $0A, $4E, $00 ; Base for 8000
	.byte $E9, $CC, $1F, $87, $B8, $B7, $C6, $00 ; Base for 8100
	.byte $B2, $97, $F2, $DD, $38, $82, $F3, $00 ; Base for 8200
	.byte $4E, $4E, $D2, $4F, $EB, $74, $A2, $00 ; Base for 8300
	.byte $3B, $D7, $A0, $0F, $4F, $51, $CF, $00 ; Base for 8400
	.byte $81, $84, $87, $8E, $81, $9C, $9F, $00 ; Base for 8500
	.byte $1A, $10, $24, $04, $4C, $44, $DC, $00 ; Base for 8600
	.byte $D9, $52, $E0, $45, $85, $0E, $04, $00 ; Base for 8700
	.byte $68, $CA, $1B, $8F, $B8, $A7, $D6, $00 ; Base for 8800
	.byte $47, $31, $BF, $DC, $A3, $1A, $5C, $00 ; Base for 8900
	.byte $D9, $54, $E6, $4F, $83, $1C, $1A, $00 ; Base for 9000
	.byte $3D, $5F, $25, $9B, $D0, $E7, $46, $00 ; Base for 9100
	.byte $50, $26, $86, $CB, $C6, $51, $DD, $00 ; Base for 9200
	.byte $6D, $4F, $95, $0A, $20, $34, $74, $00 ; Base for 9300
	.byte $C4, $55, $DD, $76, $CC, $21, $B9, $00 ; Base for 9400
	.byte $06, $B4, $B9, $D0, $A3, $02, $44, $00 ; Base for 9500
quick_resume_96:
	.byte $D6, $21, $8D, $CE, $D5, $48, $E2, $00 ; Base for 9600
	.byte $E1, $C8, $0B, $9B, $8C, $BB, $A2, $00 ; Base for 9700
	.byte $D5, $EA, $41, $95, $16, $3C, $10, $00 ; Base for 9800
	.byte $54, $3C, $94, $ED, $C4, $1F, $97, $00 ; Base for 9900

do_quick_resume:
	asl ; *= 2
	asl ; *= 4
	asl ; *= 8
	tay
	ldx #0
more_quick_resume:
	clc
	lda ($00), y
	sta PseudoRandomBitReg,x
	iny
	inx
	cpx #7
	bne more_quick_resume
	rts

prac_quick_resume:
	;
	; Get the top two digits of target rule (1234 -> 12)
	;
	lda TopScoreDisplay+2
	jsr MulByTen
	clc
	adc TopScoreDisplay+3
	ldy #0
	sty TopScoreDisplay+2 ; clear (1234 - > 34)
	sty TopScoreDisplay+3 ; clear
	cmp #$20
	bmi prac_quick_using_0
	cmp #$40
	bmi prac_quick_using_32
	cmp #$60
	bmi prac_quick_using_64
	sec
	sbc #$60
	ldx #<quick_resume_96
	stx $00
	ldx #>quick_resume_96
	stx $01
	jmp do_quick_resume

prac_quick_using_0:
	ldx #<quick_resume_0
	stx $00
	ldx #>quick_resume_0
	stx $01
	jmp do_quick_resume

prac_quick_using_32:
	sec
	sbc #$20
	ldx #<quick_resume_32
	stx $00
	ldx #>quick_resume_32
	stx $01
	jmp do_quick_resume

prac_quick_using_64:
	sec
	sbc #$40
	ldx #<quick_resume_64
	stx $00
	ldx #>quick_resume_64
	stx $01
	jmp do_quick_resume

SMALL_FIRE_FRAMES = $1b3

AdvanceToRule:
		;
		; Regardless of rule, always honor powerups
		;
		lda #0
		ldy #0
		ldx PowerUps
		beq NoPowerups
		lda #$3B
		iny
		dex
		beq BigMarioPowerup
		lda #$7A
		iny 
		dex
		beq BigMarioPowerup
		ldx #1
		ldy #2
		lda #<SMALL_FIRE_FRAMES
		;
		; Big mario
		;
BigMarioPowerup:
		stx PlayerSize
		sty PlayerStatus

NoPowerups:
    ldx #0
		stx PowerUps
		sta PowerUpFrames
		;
		; If Rule is 0, use title Rule
		; 
		lda TopScoreDisplay+2
		ora TopScoreDisplay+3
		ora TopScoreDisplay+4
		ora TopScoreDisplay+5
		bne StartAdvance
		rts
StartAdvance:
		lda IntervalTimerControl
		cmp #3
DeadLock:
		bne DeadLock
		;
		; Copy to current rule
		;
		ldx #4
KeepCopyRule:
		lda TopScoreDisplay+1,x
		sta DisplayDigits+RULE_COUNT_OFFSET-4, x
		dex
		bne KeepCopyRule
		lda #0
		sta DisplayDigits+RULE_COUNT_OFFSET-5
		;
		; Advance to correct frame rule
		;
		jsr prac_quick_resume
AdvanceFurther:
		dec TopScoreDisplay+5
		bpl CheckAdvanceFurther
		dec TopScoreDisplay+4
		bmi RuleContinue
		lda #9
		sta TopScoreDisplay+5
CheckAdvanceFurther:
		lda TopScoreDisplay+4
		ora TopScoreDisplay+5
		beq RuleContinue
RunRandomAdvance:
		jsr AdvanceRandom
		jsr AdvanceRandom
		jsr AdvanceRandom
		jsr AdvanceRandom
		jsr AdvanceRandom
		jsr AdvanceRandom
		jsr AdvanceRandom
		jsr AdvanceRandom
		jsr AdvanceRandom
		jsr AdvanceRandom
		jsr AdvanceRandom
		jsr AdvanceRandom
		jsr AdvanceRandom
		jsr AdvanceRandom
		jsr AdvanceRandom
		jsr AdvanceRandom
		jsr AdvanceRandom
		jsr AdvanceRandom
		jsr AdvanceRandom
		jsr AdvanceRandom
		jsr AdvanceRandom
		jmp AdvanceFurther
RuleContinue:
		lda #0
		sta TopScoreDisplay+5
		sta TopScoreDisplay+4
		;
		; Advance to correct place within this rule
		;
		lda #18
		sta $02
AdvanceWithin:
		jsr AdvanceRandom
		dec $02
		bne AdvanceWithin
		;
		; Advance powerup frames
		;
		lda PowerUpFrames
		cmp #<SMALL_FIRE_FRAMES
		bne StartFramePrecision
		ldx #0
CorrectForSmallFire:
		jsr AdvanceRandom
		dex
		bne CorrectForSmallFire
StartFramePrecision:
		lda PowerUpFrames
MorePowerUpFrames:
		beq NoPowerUpFrames
		jsr AdvanceRandom
		dec PowerUpFrames
		jmp MorePowerUpFrames
NoPowerUpFrames:
		;
		; Set the correct framecounter
		;
		ldy #$0e
		ldx #$a2

		lda BANK_SELECTED
		cmp #BANK_ORG
		beq @is_org
		dex
		dex
		dey
		dey
@is_org:
		lda LevelNumber
		bne SaveFrameCounter
		inx
		iny
SaveFrameCounter:
		stx FrameCounter
		sty SavedEnterTimer
		;
		; On the correct framerule, continue with the game.
		;
		rts
